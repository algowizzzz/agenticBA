<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Backend API Test</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #log {
            height: 400px;
            overflow-y: auto;
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 5px;
        }
        .log-entry.info { color: #0066cc; }
        .log-entry.success { color: #00aa00; }
        .log-entry.error { color: #cc0000; }
        input, button {
            padding: 8px;
            margin-bottom: 10px;
        }
        input {
            width: 70%;
        }
        button {
            width: 25%;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:disabled {
            background-color: #cccccc;
        }
        .container {
            margin-top: 20px;
        }
        .btn-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Backend Socket.IO API Test</h1>
    <div class="container">
        <div>
            <h3>Connection Status: <span id="status">Disconnected</span></h3>
            <div class="btn-container">
                <button id="connect">Connect</button>
                <button id="disconnect" disabled>Disconnect</button>
            </div>
        </div>
        <hr>
        <div>
            <h3>Send Message</h3>
            <input type="text" id="message" placeholder="Enter a message" disabled>
            <button id="send" disabled>Send</button>
        </div>
        <hr>
        <div>
            <h3>Test Specific Messages</h3>
            <div class="btn-container">
                <button id="test-hi" disabled>Test "hi"</button>
                <button id="test-hello" disabled>Test "hello"</button>
                <button id="test-query" disabled>Test Query</button>
            </div>
        </div>
        <hr>
        <h3>Event Log</h3>
        <div id="log"></div>
    </div>

    <script>
        // DOM Elements
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connect');
        const disconnectBtn = document.getElementById('disconnect');
        const messageInput = document.getElementById('message');
        const sendBtn = document.getElementById('send');
        const testHiBtn = document.getElementById('test-hi');
        const testHelloBtn = document.getElementById('test-hello');
        const testQueryBtn = document.getElementById('test-query');
        const logEl = document.getElementById('log');

        // Global socket variable
        let socket = null;

        // Helper functions
        function logMessage(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setConnected(isConnected) {
            statusEl.textContent = isConnected ? 'Connected' : 'Disconnected';
            statusEl.style.color = isConnected ? '#00aa00' : '#cc0000';
            
            connectBtn.disabled = isConnected;
            disconnectBtn.disabled = !isConnected;
            messageInput.disabled = !isConnected;
            sendBtn.disabled = !isConnected;
            testHiBtn.disabled = !isConnected;
            testHelloBtn.disabled = !isConnected;
            testQueryBtn.disabled = !isConnected;
        }

        // Event handlers
        connectBtn.addEventListener('click', () => {
            logMessage('Attempting to connect to the server...');
            try {
                socket = io('http://localhost:5001', {
                    reconnection: true,
                    reconnectionAttempts: 5,
                    reconnectionDelay: 1000,
                });

                // Socket events
                socket.on('connect', () => {
                    logMessage(`Connected with socket ID: ${socket.id}`, 'success');
                    setConnected(true);
                });

                socket.on('connection_success', (data) => {
                    logMessage(`Connection success: ${JSON.stringify(data)}`, 'success');
                });

                socket.on('disconnect', () => {
                    logMessage('Disconnected from server', 'error');
                    setConnected(false);
                });

                socket.on('connect_error', (error) => {
                    logMessage(`Connection error: ${error.message}`, 'error');
                });

                socket.on('agent_error', (error) => {
                    logMessage(`Agent error: ${JSON.stringify(error)}`, 'error');
                });

                socket.on('agent_step', (step) => {
                    logMessage(`Agent step: ${JSON.stringify(step)}`);
                });
            } catch (error) {
                logMessage(`Failed to initialize socket: ${error.message}`, 'error');
            }
        });

        disconnectBtn.addEventListener('click', () => {
            if (socket) {
                socket.disconnect();
                socket = null;
                logMessage('Manually disconnected from server');
                setConnected(false);
            }
        });

        sendBtn.addEventListener('click', () => {
            sendMessage(messageInput.value);
            messageInput.value = '';
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage(messageInput.value);
                messageInput.value = '';
            }
        });

        testHiBtn.addEventListener('click', () => {
            sendMessage('hi');
        });

        testHelloBtn.addEventListener('click', () => {
            sendMessage('hello');
        });

        testQueryBtn.addEventListener('click', () => {
            sendMessage('What was the stock price of AAPL on June 15, 2020?');
        });

        function sendMessage(message) {
            if (!socket || !message.trim()) return;
            
            logMessage(`Sending message: "${message}"`);
            socket.emit('chat_message', { message });
        }
    </script>
</body>
</html> 